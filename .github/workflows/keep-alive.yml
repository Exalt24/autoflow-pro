name: Keep Backend Alive

on:
  schedule:
    # Runs every 5 minutes (GitHub Actions minimum interval)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Ping Backend Health Endpoint
        run: |
          echo "üîç Starting health check at $(date)"

          # Configuration
          BACKEND_URL="https://autoflow-pro-api.onrender.com"
          HEALTH_ENDPOINT="${BACKEND_URL}/health"
          MAX_RETRIES=4
          RETRY_DELAY=20  # seconds between retries
          TIMEOUT=90      # max wait time per request (for cold starts)

          # Function to check health
          check_health() {
            local attempt=$1
            echo "üì° Attempt $attempt/$MAX_RETRIES - Pinging: $HEALTH_ENDPOINT"

            # Make request with timeout
            response=$(curl -s -w "\n%{http_code}\n%{time_total}" \
              --max-time $TIMEOUT \
              --connect-timeout 30 \
              "$HEALTH_ENDPOINT" || echo "FAILED")

            # Parse response
            http_code=$(echo "$response" | tail -n 2 | head -n 1)
            time_total=$(echo "$response" | tail -n 1)
            body=$(echo "$response" | head -n -2)

            echo "üìä HTTP Status: $http_code"
            echo "‚è±Ô∏è  Response Time: ${time_total}s"

            # Check if successful
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Health check passed!"
              echo "üìÑ Response: $body"

              # Verify response contains expected fields
              if echo "$body" | grep -q '"status".*"healthy"'; then
                echo "‚úÖ Backend is healthy and responding correctly"
                return 0
              else
                echo "‚ö†Ô∏è  Warning: Unexpected response format"
                echo "$body"
                return 1
              fi
            else
              echo "‚ùå Health check failed with status: $http_code"
              if [ "$http_code" = "FAILED" ]; then
                echo "üîå Connection failed or timed out"
              fi
              return 1
            fi
          }

          # Try multiple times with delays
          success=false
          for i in $(seq 1 $MAX_RETRIES); do
            if check_health $i; then
              success=true
              break
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "‚è≥ Waiting ${RETRY_DELAY}s before retry (cold start recovery)..."
              sleep $RETRY_DELAY
            fi
          done

          # Final result
          echo ""
          echo "=================================================="
          if [ "$success" = true ]; then
            echo "‚úÖ BACKEND IS ALIVE - Health check successful"
            echo "=================================================="
            exit 0
          else
            echo "‚ùå BACKEND IS DOWN - All retry attempts failed"
            echo "=================================================="
            echo "üö® Action required: Check Render logs"
            exit 1
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "üö® ALERT: Backend health check failed after all retries"
          echo "üìÖ Time: $(date)"
          echo "üîó Check Render dashboard: https://dashboard.render.com"
          echo "üîó Backend URL: https://autoflow-pro-api.onrender.com/health"
          echo ""
          echo "Possible causes:"
          echo "  - Render service crashed"
          echo "  - Database connection issue"
          echo "  - Redis connection issue"
          echo "  - Service exceeded free tier limits"
